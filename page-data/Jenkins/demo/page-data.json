{"componentChunkName":"component---src-templates-notebook-js","path":"/Jenkins/demo/","result":{"data":{"markdownRemark":{"html":"<div class=\"gatsby-highlight\" data-language=\"jenkinsfile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jenkinsfile line-numbers\"><code class=\"language-jenkinsfile\">node {\n    def succ_file=[]\n    def fail_file=[]\n    def file_list\n    def JKROOT=&quot;${WORKSPACE}/${target_project}&quot;\n    def HJROOT=&quot;/home/wwwroot/huajuan/app/${target_project}&quot;\n    def BAKPATH=&quot;${WORKSPACE}/rollback/${target_project}_${BUILD_NUMBER}&quot;\n    def ori_version=&#39;2015041703&#39;\n\n    echo &quot;目标项目: ${target_project}&quot;\n    echo &quot;目标版本: ${target_version}&quot;\n    echo &quot;目标服务器: ${target_server}&quot;\n\n    stage(&#39;更新代码&#39;) {\n        if ( target_files ==&#39;&#39; || target_files ==~ /\\s+|\\*+/ ){\n            echo &#39;更新文件不能为空或*&#39;\n            return\n        }\n        if ( fileExists(&quot;${JKROOT}&quot;) ){\n            sh &quot;&quot;&quot;#!/bin/bash\n                rm -fr ${JKROOT}\n            &quot;&quot;&quot;\n        }\n        checkout([$class: &#39;SubversionSCM&#39;, \n                additionalCredentials: [], \n                excludedCommitMessages: &#39;&#39;, \n                excludedRegions: &#39;&#39;, \n                excludedRevprop: &#39;&#39;, \n                excludedUsers: &#39;&#39;, \n                filterChangelog: false, \n                ignoreDirPropChanges: false, \n                includedRegions: &#39;&#39;, \n                locations: [[\n                            cancelProcessOnExternalsFail: true, \n                            credentialsId: &#39;b6da4a4f-e51c-4955-9410-16b806783390&#39;, \n                            depthOption: &#39;infinity&#39;, \n                            ignoreExternalsOption: true, \n                            local: &quot;${target_project}&quot;, \n                            remote: &#39;svn://svn.huajuanmall.com/huajuan/trunk/app/${target_project}&#39;\n                        ]], \n                quietOperation: true, \n                workspaceUpdater: [$class: &#39;UpdateUpdater&#39;]\n        ])\n    }    \n    stage(&#39;对比文件&#39;) {\n        file_list = target_files.split(&quot;\\\\s*\\\\r?\\\\n\\\\s*&quot;)\n\n        if ( !fileExists(&quot;${HJROOT}&quot;) ) {\n            echo &quot;${HJROOT} 不存在.\\n不支持新发项目&quot;\n            return\n        }\n        if ( target_version != ori_version ){\n            sh &quot;&quot;&quot;#!/bin/bash\n            echo &quot;切换版本 ${ori_version}-&gt;${target_version}&quot;\n            mv -v ${JKROOT}/${ori_version} ${JKROOT}/${target_version} \n            &quot;&quot;&quot;\n        }\n        file_list.each{\n            if ( it.length()&lt;3 ){\n                echo &quot;确定更新 ${it} ??? 这不是个文件吧?&quot;\n                return\n            }\n            if ( !fileExists(&quot;${JKROOT}/${it}&quot;) ){\n                echo &quot;${JKROOT}/${it} 不存在, 检查填写是否正确&quot;\n                return\n            }\n            if (fileExists(&quot;${HJROOT}/${it}&quot;) ) {\n                succ_file.add(it)\n            }else{\n                fail_file.add(it)\n            }\n        }\n\n    }\n    stage(&quot;预处理文件&quot;) {\n        echo succ_file.join(&#39;|&#39;)\n        echo fail_file.join(&#39;|&#39;)\n        if (fail_file.size()&gt;0){\n            echo &quot;文件 ${fail_file.join(&#39; &#39;)} 是新发文件吗?&quot;\n            input &#39;确定新发以继续&#39;\n            fail_file.each {\n                sh &quot;&quot;&quot;#!/bin/bash\n                cd ${JKROOT} &amp;&amp; rsync -azRh --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${it} ${HJROOT}/\n                &quot;&quot;&quot;\n            }\n            echo &#39;新发文件处理完成&#39;\n        }\n        if (succ_file.size()&gt;0){\n            succ_file.each {\n                echo &quot;${JKROOT}/${it}&quot;\n                echo &quot;${HJROOT}/${it}&quot;\n                sh (script:&quot;&quot;&quot;#!/bin/bash\n                diff -u ${JKROOT}/${it} ${HJROOT}/${it} || echo true\n                &quot;&quot;&quot;)\n            }\n            echo &#39;查看对比记录,确认文件是否正确&#39;\n            input &#39;确认修改文件正确?&#39;\n            sh &quot;mkdir -p ${BAKPATH}/old &amp;&amp; mkdir -p ${BAKPATH}/new&quot;\n\n            succ_file.each {\n                sh &quot;&quot;&quot;#!/bin/bash    \n                cd ${HJROOT} &amp;&amp; rsync -azRh --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${it} ${BAKPATH}/old/\n                cd ${JKROOT} &amp;&amp; rsync -azRh --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${it} ${HJROOT}/\n                &quot;&quot;&quot;\n                echo &quot;更新文件${it}处理完成&quot;\n            }\n        }\n    }\n    stage(&#39;分发服务器&#39;) {\n        input &#39;是否进行分发?&#39;\n        server_list= target_server.tokenize(&#39;,&#39;)\n        send_file = file_list.join(&quot; &quot;)\n        echo send_file\n        server_list.each {\n            echo &quot;分发到${it}&quot;\n            sh &quot;&quot;&quot;#!/bin/bash\n            cd ${JKROOT} &amp;&amp; rsync -azvR --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${send_file} www@${it}:${HJROOT}/\n            &quot;&quot;&quot;\n        }\n    }\n    stage(&quot;备份版本&quot;) {\n        bak_file = file_list.join(&quot; &quot;)\n        sh &quot;&quot;&quot;#!/bin/bash\n            mkdir -p ${BAKPATH}/new &amp;&amp; cd ${HJROOT} &amp;&amp; rsync -azvR --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${bak_file} ${BAKPATH}/new/\n            rm -fr ${JKROOT}\n        &quot;&quot;&quot;\n    }\n}node {\n    def succ_file=[]\n    def fail_file=[]\n    def file_list\n    def JKROOT=&quot;${WORKSPACE}/${target_project}&quot;\n    def HJROOT=&quot;/home/wwwroot/huajuan/app/${target_project}&quot;\n    def BAKPATH=&quot;${WORKSPACE}/rollback/${target_project}_${BUILD_NUMBER}&quot;\n    def ori_version=&#39;2015041703&#39;\n\n    echo &quot;目标项目: ${target_project}&quot;\n    echo &quot;目标版本: ${target_version}&quot;\n    echo &quot;目标服务器: ${target_server}&quot;\n\n    stage(&#39;更新代码&#39;) {\n        if ( target_files ==&#39;&#39; || target_files ==~ /\\s+|\\*+/ ){\n            echo &#39;更新文件不能为空或*&#39;\n            return\n        }\n        if ( fileExists(&quot;${JKROOT}&quot;) ){\n            sh &quot;&quot;&quot;#!/bin/bash\n                rm -fr ${JKROOT}\n            &quot;&quot;&quot;\n        }\n        checkout([$class: &#39;SubversionSCM&#39;, \n                additionalCredentials: [], \n                excludedCommitMessages: &#39;&#39;, \n                excludedRegions: &#39;&#39;, \n                excludedRevprop: &#39;&#39;, \n                excludedUsers: &#39;&#39;, \n                filterChangelog: false, \n                ignoreDirPropChanges: false, \n                includedRegions: &#39;&#39;, \n                locations: [[\n                            cancelProcessOnExternalsFail: true, \n                            credentialsId: &#39;b6da4a4f-e51c-4955-9410-16b806783390&#39;, \n                            depthOption: &#39;infinity&#39;, \n                            ignoreExternalsOption: true, \n                            local: &quot;${target_project}&quot;, \n                            remote: &#39;svn://svn.huajuanmall.com/huajuan/trunk/app/${target_project}&#39;\n                        ]], \n                quietOperation: true, \n                workspaceUpdater: [$class: &#39;UpdateUpdater&#39;]\n        ])\n    }    \n    stage(&#39;对比文件&#39;) {\n        file_list = target_files.split(&quot;\\\\s*\\\\r?\\\\n\\\\s*&quot;)\n\n        if ( !fileExists(&quot;${HJROOT}&quot;) ) {\n            echo &quot;${HJROOT} 不存在.\\n不支持新发项目&quot;\n            return\n        }\n        if ( target_version != ori_version ){\n            sh &quot;&quot;&quot;#!/bin/bash\n            echo &quot;切换版本 ${ori_version}-&gt;${target_version}&quot;\n            mv -v ${JKROOT}/${ori_version} ${JKROOT}/${target_version} \n            &quot;&quot;&quot;\n        }\n        file_list.each{\n            if ( it.length()&lt;3 ){\n                echo &quot;确定更新 ${it} ??? 这不是个文件吧?&quot;\n                return\n            }\n            if ( !fileExists(&quot;${JKROOT}/${it}&quot;) ){\n                echo &quot;${JKROOT}/${it} 不存在, 检查填写是否正确&quot;\n                return\n            }\n            if (fileExists(&quot;${HJROOT}/${it}&quot;) ) {\n                succ_file.add(it)\n            }else{\n                fail_file.add(it)\n            }\n        }\n\n    }\n    stage(&quot;预处理文件&quot;) {\n        echo succ_file.join(&#39;|&#39;)\n        echo fail_file.join(&#39;|&#39;)\n        if (fail_file.size()&gt;0){\n            echo &quot;文件 ${fail_file.join(&#39; &#39;)} 是新发文件吗?&quot;\n            input &#39;确定新发以继续&#39;\n            fail_file.each {\n                sh &quot;&quot;&quot;#!/bin/bash\n                cd ${JKROOT} &amp;&amp; rsync -azRh --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${it} ${HJROOT}/\n                &quot;&quot;&quot;\n            }\n            echo &#39;新发文件处理完成&#39;\n        }\n        if (succ_file.size()&gt;0){\n            succ_file.each {\n                echo &quot;${JKROOT}/${it}&quot;\n                echo &quot;${HJROOT}/${it}&quot;\n                sh (script:&quot;&quot;&quot;#!/bin/bash\n                diff -u ${JKROOT}/${it} ${HJROOT}/${it} || echo true\n                &quot;&quot;&quot;)\n            }\n            echo &#39;查看对比记录,确认文件是否正确&#39;\n            input &#39;确认修改文件正确?&#39;\n            sh &quot;mkdir -p ${BAKPATH}/old &amp;&amp; mkdir -p ${BAKPATH}/new&quot;\n\n            succ_file.each {\n                sh &quot;&quot;&quot;#!/bin/bash    \n                cd ${HJROOT} &amp;&amp; rsync -azRh --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${it} ${BAKPATH}/old/\n                cd ${JKROOT} &amp;&amp; rsync -azRh --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${it} ${HJROOT}/\n                &quot;&quot;&quot;\n                echo &quot;更新文件${it}处理完成&quot;\n            }\n        }\n    }\n    stage(&#39;分发服务器&#39;) {\n        input &#39;是否进行分发?&#39;\n        server_list= target_server.tokenize(&#39;,&#39;)\n        send_file = file_list.join(&quot; &quot;)\n        echo send_file\n        server_list.each {\n            echo &quot;分发到${it}&quot;\n            sh &quot;&quot;&quot;#!/bin/bash\n            cd ${JKROOT} &amp;&amp; rsync -azvR --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${send_file} www@${it}:${HJROOT}/\n            &quot;&quot;&quot;\n        }\n    }\n    stage(&quot;备份版本&quot;) {\n        bak_file = file_list.join(&quot; &quot;)\n        sh &quot;&quot;&quot;#!/bin/bash\n            mkdir -p ${BAKPATH}/new &amp;&amp; cd ${HJROOT} &amp;&amp; rsync -azvR --exclude=&#39;.svn&#39; --exclude=&#39;*.log&#39; ${bak_file} ${BAKPATH}/new/\n            rm -fr ${JKROOT}\n        &quot;&quot;&quot;\n    }\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","tableOfContents":""}},"pageContext":{"isCreatedByStatefulCreatePages":false,"title":"demo","tableOfContentsAST":[],"headingIDs":[]}}}